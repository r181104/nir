#!/bin/sh

set -e

echo "=== Enabling PipeWire services to start automatically ==="
systemctl --user enable --now pipewire.socket pipewire-pulse.socket wireplumber.service

echo "=== Restarting PipeWire services ==="
systemctl --user restart pipewire pipewire-pulse wireplumber

echo "=== Waiting for PipeWire to initialize sinks ==="
# Wait up to 5 seconds for sinks to appear
timeout=5
while [ $timeout -gt 0 ]; do
  SINK=$(wpctl status | awk '/Sinks:/,/^$/ {if ($1 ~ /^[0-9]+:/) {print $1; exit}}')
  if [ -n "$SINK" ]; then
    echo "Found sink: $SINK"
    wpctl set-default "$SINK"
    break
  fi
  sleep 1
  timeout=$((timeout - 1))
done

if [ -z "$SINK" ]; then
  echo "Warning: No PipeWire sinks found. Audio might not work."
else
  echo "Default sink set to $SINK"
fi

echo "=== PipeWire initialization complete ==="
