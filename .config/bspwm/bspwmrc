#!/bin/sh

# === NVIDIA PRIME / hybrid graphics ===
if xrandr --listproviders 2>/dev/null | grep -q NVIDIA; then
  xrandr --setprovideroutputsource modesetting NVIDIA-0 || echo "Failed to set NVIDIA provider"
fi

# === Keyboard & Mouse ===
xset r rate 200 50
xset -b
xset s off -dpms

# === Numlock & Gestures ===
command -v numlockx >/dev/null 2>&1 && numlockx &
command -v libinput-gestures >/dev/null 2>&1 &&
  pgrep -f libinput-gestures >/dev/null || libinput-gestures &

# === Touchpad & TrackPoint (auto-detect) ===
for id in $(xinput list --id-only | xargs -n1 xinput list-props | grep -B1 "Touchpad\|TrackPoint" | grep "id=" | awk '{print $4}'); do
  name=$(xinput list "$id" | grep -o '".*"' | tr -d '"')
  if echo "$name" | grep -qi touchpad; then
    xinput set-prop "$id" "libinput Tapping Enabled" 1
    xinput set-prop "$id" "libinput Natural Scrolling Enabled" 0
    xinput set-prop "$id" "libinput Disable While Typing Enabled" 1
    xinput set-prop "$id" "libinput Accel Speed" 0.3
  elif echo "$name" | grep -qi trackpoint; then
    xinput set-prop "$id" "libinput Accel Speed" 0.0
  fi
done

# === Monitor setup (auto-detect connected) ===
for output in $(xrandr | grep " connected" | awk '{print $1}'); do
  xrandr --output "$output" --mode 1920x1080 --rate 60.00 2>/dev/null
done

# === Background apps (no duplicates) ===
for app in dunst picom sxhkd nm-applet blueman-applet; do
  pgrep -x "$app" >/dev/null || $app &
done

# === Wallpaper & Polybar ===
wal -R &
sh ~/nir/.local/bin/launch-poly &

# === Cursor theme ===
if [ -f "$HOME/.local/share/icons/Bibata-Modern-Ice/cursors/left_ptr" ]; then
  xsetroot -cursor_name left_ptr
  xsetroot -xcf "$HOME/.local/share/icons/Bibata-Modern-Ice/cursors/left_ptr" 30
fi

# === bspwm setup ===
bspc monitor -d I II III IV V VI VII VIII IX X

bspc config border_width 2
bspc config window_gap 3
bspc config pointer_follows_monitor true
bspc config focus_follows_pointer true

# Load wal colors
if [ -f "${HOME}/.cache/wal/colors.sh" ]; then
  . "${HOME}/.cache/wal/colors.sh"
  bspc config normal_border_color "$color1"
  bspc config active_border_color "$color2"
  bspc config focused_border_color "$color15"
  bspc config presel_feedback_color "$color1"
fi

# Rules
bspc rule -a mumble state=floating follow=on focus=on
bspc rule -a brave state=fullscreen follow=on focus=on
